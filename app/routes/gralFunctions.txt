import json
from pathlib import Path
from typing import List
from fastapi import APIRouter, Depends, Request
from sqlalchemy.orm import Session

from ___loggin___.logger import GetLogger
from app.database import get_db
from app.validation import auth_required
from app.schemas.gralFunctions import MainFunctions, InventarioMainFunctions

logger = GetLogger("GeneralFunctions")

router = APIRouter(prefix="/GeneralFunctions", tags=["General Functions"])


@router.get("/MainFunctions", response_model=List[MainFunctions], dependencies=[Depends(auth_required)])
def get_main_functions(request: Request, db: Session = Depends(get_db)):
    """Return the list of main functions loaded from MainFunctions.json."""

    # logger.info(f"Cookies recibidas: {request.cookies}")

    json_path = Path(__file__).resolve().parent.parent / "src" / "json" / "MainFunctions.json"

    if not json_path.exists():
        logger.warning("Archivo MainFunctions.json no encontrado")
        return []

    try:
        with open(json_path, "r", encoding="utf-8") as f:
            data = json.load(f)
            logger.info(f"{len(data)} funciones cargadas desde MainFunctions.json")
            return data
    except Exception as e:
        logger.error(f"Error al leer el JSON: {str(e)}")
        return []


@router.get("/InventarioMainFunctions", response_model=List[InventarioMainFunctions], dependencies=[Depends(auth_required)])
def get_inventario_main_functions(db: Session = Depends(get_db)):
    """Return the list of inventory main functions loaded from InventarioMainFunctions.json."""

    json_path = Path(__file__).resolve().parent.parent / "src" / "json" / "InventarioMainFunctions.json"

    if not json_path.exists():
        logger.warning("Archivo InventarioMainFunctions.json no encontrado")
        return []

    try:
        with open(json_path, "r", encoding="utf-8") as f:
            data = json.load(f)
            logger.info(f"{len(data)} funciones cargadas desde InventarioMainFunctions.json")
            return data
    except Exception as e:
        logger.error(f"Error al leer el JSON: {str(e)}")
        return []
